{
  "name": "CONFIRM_DEAL (Create & Update)",
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.isUpdate }}",
              "value2": "={{ true }}"
            }
          ]
        }
      },
      "name": "Is Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        224,
        864
      ],
      "id": "c7cd0e5b-f615-4083-bc39-3e5a08326f5b"
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "={{ $json.crmBaseUrl }}/api/resource/CRM%20Deal/{{ $json.docName }}",
        "jsonParameters": true,
        "options": {
          "fullResponse": true
        },
        "bodyParametersJson": "={{ $json.dealData }}",
        "headerParametersJson": "={\n  \"Authorization\": \"{{ 'token ' + $('Wait for Confirmation1').item.json.body.frappeApiKey + ':' + $('Wait for Confirmation1').item.json.body.frappeApiSecret }}\"\n}"
      },
      "name": "Update Deal",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        448,
        928
      ],
      "id": "20c6ab5a-eeb6-4a1d-9725-18682adbae29",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const dealDataNode = $('dealData').item.json;\nconst docName = dealDataNode.docName || $('Create Deal1').item.json.body.data.name;\nconst action = dealDataNode.isUpdate ? 'updated' : 'created';\n\nreturn {\n  json: {\n    name: docName,\n    action: action,\n    chatId: dealDataNode.chatId,\n    crmBaseUrl: dealDataNode.crmBaseUrl\n  }\n};"
      },
      "name": "Get Final Deal Name",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        1104
      ],
      "id": "2ace1c9c-c9f5-4d87-87d7-24b9223ad724"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.statusCode }}",
              "value2": "={{ 200 }}"
            }
          ]
        }
      },
      "name": "Deal Status?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        672,
        720
      ],
      "id": "2de759d4-4b5e-4a80-bb48-ded343c79573"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('dealData').item.json.dealData.tasks && $('dealData').item.json.dealData.tasks.length > 0 }}",
              "value2": "={{ true }}"
            }
          ]
        }
      },
      "name": "Check for Tasks1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        672,
        560
      ],
      "id": "3cf6e6dd-6906-42f5-9681-0c1b73cdbf9f"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const dealDataItem = $('dealData').item.json;\n\n// Get the final Deal Name (either the new ID from Create Deal or the docName from Update)\nconst dealReferenceName = $('Deal Status?').item.json.name || dealDataItem.docName || '';\nconst tasks = (dealDataItem.dealData && dealDataItem.dealData.tasks) || [];\n\n// Use the human-readable name for the Telegram message\nconst extractedDealName = dealDataItem.dealData.name || ''; \n\nreturn {\n    items: tasks.map(task => ({\n        json: {\n            title: task.title || '',\n            description: task.description || '',\n            due_date: task.due_date || new Date().toISOString().split('T')[0],\n            \n            // Use the system ID for linking to the document\n            dealReferenceName: dealReferenceName,\n            chatId: dealDataItem.chatId || '',\n            crmBaseUrl: dealDataItem.crmBaseUrl || '',\n            frappeApiKey: dealDataItem.frappeApiKey || '',\n            frappeApiSecret: dealDataItem.frappeApiSecret || '',\n            \n            // Use the human-readable name for confirmation message\n            dealName: extractedDealName \n        }\n    }))\n};"
      },
      "name": "Iterate Tasks1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        560
      ],
      "id": "456a5623-b079-47d1-a955-8af61584789a"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.items[0].json.crmBaseUrl }}api/resource/CRM%20Task",
        "jsonParameters": true,
        "options": {
          "bodyContentType": "raw"
        },
        "bodyParametersJson": "={{ { \"title\": $json.items[0].json.title, \"description\": $json.items[0].json.description, \"due_date\": $json.items[0].json.due_date, \"reference_doctype\": \"CRM Deal\", \"reference_name\": $json.items[0].json.dealReferenceName } }}",
        "headerParametersJson": "={{ { \"Authorization\": \"token \" + $json.items[0].json.frappeApiKey + \":\" + $json.items[0].json.frappeApiSecret } }}"
      },
      "name": "Create Task1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1104,
        560
      ],
      "id": "6b3ddc36-4de0-4b9c-83d4-beaae1e53f9e"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"chat_id\": {{ $(\"dealData\").item.json.chatId }},\n  \"text\": \"Task '{{ $(\"dealData\").item.json.dealData.tasks[0].title }}' created for Deal '{{ $(\"dealData\").item.json.dealData.name }}'!\",\n  \"parse_mode\": \"Markdown\"\n}"
      },
      "name": "Send Task Confirmation1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1312,
        560
      ],
      "id": "a938920c-d0bb-4426-9965-b8f8dfcf3d30"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('dealData').item.json.dealData.notes && $('dealData').item.json.dealData.notes.length > 0 }}",
              "value2": "={{ true }}"
            }
          ]
        }
      },
      "name": "Check for Notes1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        672,
        896
      ],
      "id": "33fa3022-f294-4db3-b289-3066acac0886"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const dealDataItem = $('dealData').item.json;\n\n// Get the final Deal Name (either the new ID from Create Deal or the docName from Update)\nconst dealReferenceName = $('Deal Status?').item.json.name || dealDataItem.docName || '';\nconst notes = (dealDataItem.dealData && dealDataItem.dealData.notes) || [];\n\n// Use the human-readable name for the Telegram message\nconst extractedDealName = dealDataItem.dealData.name || '';\n\nreturn {\n    items: notes.map(note => ({\n        json: {\n            title: note.title || '',\n            content: note.content || '',\n            \n            // Context data for the next step (Create Note)\n            dealReferenceName: dealReferenceName,\n            chatId: dealDataItem.chatId || '',\n            crmBaseUrl: dealDataItem.crmBaseUrl || '',\n            frappeApiKey: dealDataItem.frappeApiKey || '',\n            frappeApiSecret: dealDataItem.frappeApiSecret || '',\n            \n            // USE THE CORRECTLY EXTRACTED NAME\n            dealName: extractedDealName\n        }\n    }))\n};"
      },
      "name": "Iterate Notes1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        880
      ],
      "id": "9ec1d5e4-215f-46c8-a22a-3079c1556704"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.items[0].json.crmBaseUrl }}api/resource/FCRM%20Note",
        "jsonParameters": true,
        "options": {
          "bodyContentType": "raw"
        },
        "bodyParametersJson": "={{ { \"title\": $json.items[0].json.title, \"content\": $json.items[0].json.content, \"reference_doctype\": \"CRM Deal\", \"reference_name\": $json.items[0].json.dealReferenceName } }}",
        "headerParametersJson": "={{ { \"Authorization\": \"token \" + $json.items[0].json.frappeApiKey + \":\" + $json.items[0].json.frappeApiSecret } }}"
      },
      "name": "Create Note1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1120,
        880
      ],
      "id": "f50f51e4-359a-41b4-9e55-01cb712621a9"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"chat_id\": {{ $(\"dealData\").item.json.chatId }},\n  \"text\": \"Note '{{ $(\"dealData\").item.json.dealData.notes[0].title }}' created for Deal '{{ $(\"dealData\").item.json.dealData.name }}'!\",\n  \"parse_mode\": \"Markdown\"\n}"
      },
      "name": "Send Note Confirmation1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1312,
        880
      ],
      "id": "0298cc7e-f22b-4545-a7f6-3618a78740d1"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ ($('dealData').item.json.dealData.name || '').trim() }}",
        "rules": {
          "rules": [
            {
              "value2": "={{ '' }}",
              "output": 1
            },
            {
              "operation": "notEqual",
              "value2": "={{ '' }}"
            }
          ]
        }
      },
      "name": "Check Mandatory Fields1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        0,
        928
      ],
      "id": "f88b64f3-6da8-4b84-9a2a-757853ae8173"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {
          "bodyContentType": "raw"
        },
        "bodyParametersJson": "={\n  \"chat_id\": {{$json.chatId}},\n  \"text\": \"Please provide the *Deal Name* to create/update the deal. It is mandatory, so record again please!\",\n  \"parse_mode\": \"Markdown\"\n}\n"
      },
      "name": "Prompt User1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        224,
        1056
      ],
      "id": "191a0ffb-0125-4708-91d4-df822b93a7da"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.crmBaseUrl }}/api/resource/CRM%20Deal",
        "jsonParameters": true,
        "options": {
          "fullResponse": true
        },
        "bodyParametersJson": "={{ $json.dealData }}",
        "headerParametersJson": "={\n  \"Authorization\": \"{{ 'token ' + $('Wait for Confirmation1').item.json.body.frappeApiKey + ':' + $('Wait for Confirmation1').item.json.body.frappeApiSecret }}\"\n}"
      },
      "name": "Create Deal1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        448,
        768
      ],
      "id": "f54c3be9-429e-4d46-abf9-66348e3a5d04",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const dealData = { ...$json.body.dealData };\n\n// Check if it's a creation flow based on docName absence in the payload\n// We need to ensure that tasks/notes keys are present for the Check nodes to run\nif (!dealData.tasks) dealData.tasks = [];\nif (!dealData.notes) dealData.notes = [];\n\nreturn {\n  json: {\n    draftId: $json.body.draftId,\n    chatId: $json.body.chatId,\n    crmBaseUrl: $json.body.crmBaseUrl,\n    frappeApiKey: $json.body.frappeApiKey,\n    frappeApiSecret: $json.body.frappeApiSecret,\n    dealData,\n    isUpdate: $json.body.isUpdate || false,\n    docName: $json.body.docName || null\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        960
      ],
      "id": "5f4dc374-d4ae-48bc-bde6-1cba2fa4389e",
      "name": "dealData"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "CONFIRM_DEAL",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -448,
        960
      ],
      "id": "41b83e58-8935-4d87-aa24-50c78b871f95",
      "name": "Wait for Confirmation1",
      "webhookId": "f69f5152-6e49-41f0-a5a2-9424e8e4310e"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"Deal successfully *{{ $json.action }}*!\\nView here: {{ $json.crmBaseUrl }}app/crm-deal/{{ $json.name }}\",\n  \"parse_mode\": \"Markdown\"\n}"
      },
      "name": "Send CRM Link1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        912,
        1104
      ],
      "id": "bc4be6ab-5398-47dd-920a-8375f34d5f55"
    }
  ],
  "pinData": {},
  "connections": {
    "Is Update?": {
      "main": [
        [
          {
            "node": "Update Deal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Deal1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Deal": {
      "main": [
        [
          {
            "node": "Deal Status?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deal Status?": {
      "main": [
        [
          {
            "node": "Get Final Deal Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Final Deal Name": {
      "main": [
        [
          {
            "node": "Send CRM Link1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check for Tasks1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check for Notes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Tasks1": {
      "main": [
        [
          {
            "node": "Iterate Tasks1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iterate Tasks1": {
      "main": [
        [
          {
            "node": "Create Task1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Task1": {
      "main": [
        [
          {
            "node": "Send Task Confirmation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Notes1": {
      "main": [
        [
          {
            "node": "Iterate Notes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iterate Notes1": {
      "main": [
        [
          {
            "node": "Create Note1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Note1": {
      "main": [
        [
          {
            "node": "Send Note Confirmation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Mandatory Fields1": {
      "main": [
        [
          {
            "node": "Is Update?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prompt User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Deal1": {
      "main": [
        [
          {
            "node": "Deal Status?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dealData": {
      "main": [
        [
          {
            "node": "Check Mandatory Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Confirmation1": {
      "main": [
        [
          {
            "node": "dealData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7b72ecf9-7450-4c1b-bb16-362ee7399a13",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6b4c3f07ffb2a9fbb4da3043f5991767bcfa9a87470082c7cd7bb38a6a0433a3"
  },
  "id": "YLDuL4KIoUFHe8ju",
  "tags": []
}