{
  "name": "CONFIRM_LEAD (Create & Update)",
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.isUpdate }}",
              "value2": "={{ true }}"
            }
          ]
        }
      },
      "name": "Is Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        896,
        4416
      ],
      "id": "9c97c04e-8d70-4d68-9ae6-53bff3d44eb5"
    },
    {
      "parameters": {
        "requestMethod": "PUT",
        "url": "={{ $json.crmBaseUrl }}/api/resource/CRM%20Lead/{{ $json.docName }}",
        "jsonParameters": true,
        "options": {
          "fullResponse": true
        },
        "bodyParametersJson": "={{ $json.leadData }}",
        "headerParametersJson": "={\n  \"Authorization\": \"{{ 'token ' + $('Wait for Confirmation').item.json.body.frappeApiKey + ':' + $('Wait for Confirmation').item.json.body.frappeApiSecret }}\"\n}"
      },
      "name": "Update Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1120,
        4592
      ],
      "id": "5fcbab35-9d0e-4cff-8e8d-395e9f9b2c62",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('leadData1').item.json.leadData.tasks && $('leadData1').item.json.leadData.tasks.length > 0 }}",
              "value2": "={{ true }}"
            }
          ]
        }
      },
      "name": "Check for Tasks",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1536,
        4224
      ],
      "id": "1203ccec-94c1-4e5f-81e5-5008a09fab65"
    },
    {
      "parameters": {
        "jsCode": "const leadDataItem = $('leadData1').item.json;\n\n// Get the final Lead Name (either the new ID from Create Lead or the docName from Update)\nconst leadReferenceName = $('Lead Created?1').item.json.body.data.name || leadDataItem.docName || '';\nconst tasks = (leadDataItem.leadData && leadDataItem.leadData.tasks) || [];\n\n// Use the human-readable name for the Telegram message\nconst extractedLeadName = (leadDataItem.leadData.first_name || '') + ' ' + (leadDataItem.leadData.last_name || ''); \n\nreturn {\n  items: tasks.map(task => ({\n    json: {\n        title: task.title || '',\n        description: task.description || '',\n        due_date: task.due_date || '2025-11-28', \n        \n        // Use the system ID for linking to the document\n        leadReferenceName: leadReferenceName,\n        chatId: leadDataItem.chatId || '',\n        crmBaseUrl: leadDataItem.crmBaseUrl || '',\n        frappeApiKey: leadDataItem.frappeApiKey || '',\n        frappeApiSecret: leadDataItem.frappeApiSecret || '',\n        \n        // Use the human-readable name for confirmation message\n        leadName: extractedLeadName \n      }\n  }))\n};"
      },
      "name": "Iterate Tasks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        4208
      ],
      "id": "76f5d26f-faad-46a1-8ce3-71706147bb61"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.items[0].json.crmBaseUrl }}/api/resource/CRM%20Task",
        "jsonParameters": true,
        "options": {
          "bodyContentType": "raw"
        },
        "bodyParametersJson": "={{ JSON.stringify({ title: $json.items[0].json.title, description: $json.items[0].json.description || '', due_date: $json.items[0].json.due_date || '2025-11-28', reference_doctype: 'CRM Lead', reference_name: $json.items[0].json.leadReferenceName }) }}",
        "headerParametersJson": "={{ { \"Authorization\": \"token \" + $json.items[0].json.frappeApiKey + \":\" + $json.items[0].json.frappeApiSecret } }}"
      },
      "name": "Create Task",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1968,
        4208
      ],
      "id": "9dd7c170-a6c7-45df-a121-6efe6df33601"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"chat_id\": {{ $(\"leadData1\").item.json.chatId }},\n  \"text\": \"Task '{{ $(\"leadData1\").item.json.leadData.tasks[0].title }}' created for '{{ $(\"leadData1\").item.json.leadData.first_name + ' ' + $(\"leadData1\").item.json.leadData.last_name }}'!\\nView all tasks: [Task List]({{ $(\"leadData1\").item.json.crmBaseUrl + 'crm/tasks/view' }})\",\n  \"parse_mode\": \"Markdown\"\n}"
      },
      "name": "Send Task Confirmation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2176,
        4208
      ],
      "id": "d5b6be96-7e6b-4aec-b0ee-3f308bed6f2b"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('leadData1').item.json.leadData.notes && $('leadData1').item.json.leadData.notes.length > 0 }}",
              "value2": "={{ true }}"
            }
          ]
        }
      },
      "name": "Check for Notes",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1536,
        4512
      ],
      "id": "6ebbcddb-eb67-4e45-9efb-a5a7057e4934"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const leadDataItem = $('leadData1').item.json;\n\n// Get the final Lead Name (either the new ID from Create Lead or the docName from Update)\nconst leadReferenceName = $('Lead Created?1').item.json.body.data.name || leadDataItem.docName || '';\nconst notes = (leadDataItem.leadData && leadDataItem.leadData.notes) || [];\n\n// Use the human-readable name for the Telegram message\nconst extractedLeadName = (leadDataItem.leadData.first_name || '') + ' ' + (leadDataItem.leadData.last_name || ''); \n\nreturn {\n  items: notes.map(note => ({\n    json: {\n        title: note.title || '',\n        content: note.content || '',\n        \n        // Context data for the next step (Create Note)\n        leadReferenceName: leadReferenceName,\n        chatId: leadDataItem.chatId || '',\n        crmBaseUrl: leadDataItem.crmBaseUrl || '',\n        frappeApiKey: leadDataItem.frappeApiKey || '',\n        frappeApiSecret: leadDataItem.frappeApiSecret || '',\n        \n        // USE THE CORRECTLY EXTRACTED NAME\n        leadName: extractedLeadName\n      }\n  }))\n};"
      },
      "name": "Iterate Notes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        4496
      ],
      "id": "5575f0ff-e51e-4902-b06c-7e55670844ed"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.items[0].json.crmBaseUrl }}/api/resource/FCRM%20Note",
        "jsonParameters": true,
        "options": {
          "bodyContentType": "raw"
        },
        "bodyParametersJson": "={{ {\ntitle: $json.items[0].json.title,\ncontent: $json.items[0].json.content || '',\nreference_doctype: \"CRM Lead\",\nreference_name: $json.items[0].json.leadReferenceName\n} }}",
        "headerParametersJson": "={{ { \"Authorization\": \"token \" + $json.items[0].json.frappeApiKey + \":\" + $json.items[0].json.frappeApiSecret } }}"
      },
      "name": "Create Note",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2016,
        4496
      ],
      "id": "516a68af-6d62-4b53-93a3-e205e26f6c27"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"chat_id\": {{ $(\"leadData1\").item.json.chatId }},\n  \"text\": \"Note '{{ $(\"leadData1\").item.json.leadData.notes[0].title }}' created for '{{ $(\"leadData1\").item.json.leadData.first_name + ' ' + $(\"leadData1\").item.json.leadData.last_name }}'!\\nView all notes: [Note List]({{ $(\"leadData1\").item.json.crmBaseUrl + 'crm/notes/view' }})\",\n  \"parse_mode\": \"Markdown\"\n}"
      },
      "name": "Send Note Confirmation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        2224,
        4496
      ],
      "id": "590b0314-8758-4839-a7a1-e5d6fb0a2297"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "CONFIRM_LEAD",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        224,
        4512
      ],
      "id": "bc2a12fc-9e59-4926-ab7c-7958cc497b53",
      "name": "Wait for Confirmation",
      "webhookId": "f69f5152-6e49-41f0-a5a2-9424e8e4310e"
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ ($('leadData1').item.json.leadData.first_name || '').trim() }}",
        "rules": {
          "rules": [
            {
              "operation": "=equal",
              "value2": "={{ '' }}",
              "output": 1
            },
            {
              "operation": "notEqual",
              "value2": "={{ '' }}"
            }
          ]
        }
      },
      "name": "Check Mandatory Fields",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        672,
        4480
      ],
      "id": "91af2b5b-a1bc-42c7-a1ae-524ca7fbf65b"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={{\n  \"chat_id\": $json.chatId,\n  \"text\": \"Please provide your *First Name* to create/update the lead it is mandatory so Record again please!\",\n  \"parse_mode\": \"Markdown\"\n}}"
      },
      "name": "Prompt User",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        912,
        4768
      ],
      "id": "677a52ae-8de0-4534-9a9a-209f1a1c9d1c"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json.crmBaseUrl }}/api/resource/CRM%20Lead",
        "jsonParameters": true,
        "options": {
          "fullResponse": true
        },
        "bodyParametersJson": "={{ $json.leadData }}",
        "headerParametersJson": "={\n  \"Authorization\": \"{{ 'token ' + $('Wait for Confirmation').item.json.body.frappeApiKey + ':' + $('Wait for Confirmation').item.json.body.frappeApiSecret }}\"\n}"
      },
      "name": "Create Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1120,
        4224
      ],
      "id": "e8596043-1726-455b-a30c-7fef5e04d182",
      "alwaysOutputData": false,
      "executeOnce": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "https://api.telegram.org/bot8453286778:AAFGJHgj7gO40706uyBBBlyWqvLmPBMUEko/sendMessage",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={{\nJSON.stringify({\nchat_id: $(\"leadData1\").item.json.chatId,\ntext: \"Lead successfully *\" + ($(\"leadData1\").item.json.isUpdate ? 'updated' : 'created') + \"*! View here: \" + $(\"leadData1\").item.json.crmBaseUrl + \"app/crm-lead/\" + ($(\"Lead Created?1\").item.json.body.data.name || $(\"leadData1\").item.json.docName || 'unknown'),\nparse_mode: \"Markdown\"\n})\n}}"
      },
      "name": "Send CRM Link",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1536,
        4720
      ],
      "id": "90be2048-f852-400c-9c6b-ded2ff47591d"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const leadData = { ...$json.body.leadData };\n\n// Remove tasks/notes if empty, but ensure we keep the array if it has data\nif (!leadData.tasks) leadData.tasks = [];\nif (!leadData.notes) leadData.notes = [];\n\nreturn {\n  json: {\n    draftId: $json.body.draftId,\n    chatId: $json.body.chatId,\n    crmBaseUrl: $json.body.crmBaseUrl,\n    frappeApiKey: $json.body.frappeApiKey,\n    frappeApiSecret: $json.body.frappeApiSecret,\n    leadData,\n    // ADDED: Pass through the new fields from the draft generator\n    isUpdate: $json.body.isUpdate || false,\n    docName: $json.body.docName || null\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        4512
      ],
      "id": "77601304-9c60-4454-ad35-16a0f815f1d1",
      "name": "leadData1"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.statusCode }}",
              "value2": "={{ 200 }}"
            }
          ]
        }
      },
      "name": "Lead Created?1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1344,
        4416
      ],
      "id": "cf65db6a-56b1-4183-a2b7-60799c8971e1"
    }
  ],
  "pinData": {},
  "connections": {
    "Is Update?": {
      "main": [
        [
          {
            "node": "Update Lead",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead": {
      "main": [
        [
          {
            "node": "Lead Created?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Tasks": {
      "main": [
        [
          {
            "node": "Iterate Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iterate Tasks": {
      "main": [
        [
          {
            "node": "Create Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Task": {
      "main": [
        [
          {
            "node": "Send Task Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Notes": {
      "main": [
        [
          {
            "node": "Iterate Notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iterate Notes": {
      "main": [
        [
          {
            "node": "Create Note",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Note": {
      "main": [
        [
          {
            "node": "Send Note Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Confirmation": {
      "main": [
        [
          {
            "node": "leadData1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Mandatory Fields": {
      "main": [
        [
          {
            "node": "Is Update?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prompt User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Lead": {
      "main": [
        [
          {
            "node": "Lead Created?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "leadData1": {
      "main": [
        [
          {
            "node": "Check Mandatory Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Created?1": {
      "main": [
        [
          {
            "node": "Send CRM Link",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check for Tasks",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check for Notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ebcdc3a3-2e40-4e79-8e41-b69f85833675",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6b4c3f07ffb2a9fbb4da3043f5991767bcfa9a87470082c7cd7bb38a6a0433a3"
  },
  "id": "EkuXG53ornPSfxFJ",
  "tags": []
}